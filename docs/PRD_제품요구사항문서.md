# 마켓플레이스 판매자 정산 시스템 PRD
## 제품 요구사항 문서 (Product Requirements Document)

**버전**: 1.0
**작성일**: 2025-12-09
**작성자**: 개발팀

---

## 1. 제품 개요

### 1.1 제품 정의
마켓플레이스 판매자 정산 시스템은 대규모 마켓플레이스에서 발생하는 수많은 판매자들의 주문, 결제, 환불 데이터를 처리하여 일일 정산금을 자동으로 계산하고 지급하는 백엔드 시스템입니다.

### 1.2 문제 정의
**"어제 판매자 A가 얼마를 벌었고, 우리는 얼마를 지급해야 하는가?"**

이 단순한 질문에 답하기 위해 다음과 같은 복잡성을 해결해야 합니다:
- 수천 개의 판매자, 수만 건의 일일 거래 처리
- 복잡한 환불 시나리오(전체/부분 환불)
- 판매자별 상이한 수수료 정책
- 정확한 금액 계산 및 부가세 처리
- 중복 정산 방지를 위한 멱등성 보장

### 1.3 제품 목표
1. **정확성**: 오차 없는 정산 금액 계산 (BigDecimal 기반)
2. **신뢰성**: 중복 정산 방지, 실패 시 재처리 기능
3. **효율성**: 대용량 데이터를 빠르고 안정적으로 처리
4. **추적성**: 모든 정산 항목의 원천 데이터 역추적 가능
5. **확장성**: 향후 다양한 정산 주기(주간, 월간)로 확장 가능

---

## 2. 기능 요구사항

### 2.1 핵심 기능

#### 2.1.1 일일 정산 배치 (UC-S1)
- **실행 주기**: 매일 새벽 02:00 (자동 스케줄링)
- **처리 대상**: 전일 결제 완료된 모든 주문
- **처리 범위**:
  - 판매자별 집계
  - 수수료 계산 (판매자별 율 적용)
  - 부가세 자동 계산 (수수료의 10%)
  - 환불 금액 차감
- **출력물**:
  - settlements (정산 마스터)
  - settlement_items (정산 상세 항목)

#### 2.1.2 정산 재실행 (UC-S2)
- **재정산 조건**:
  - 데이터 오류 발생
  - 수동 조정 필요
  - 환불 미반영 등
- **처리 로직**:
  1. 기존 정산 상태를 CANCELED로 변경
  2. 새로운 정산 생성 및 계산
  3. 멱등성 보장 (기간별 1개만 ACTIVE 상태)
- **권한**: 관리자만 실행 가능

#### 2.1.3 정산 조회 기능 (UC-S3, UC-S4)
- **판매자 정산 목록 조회**:
  - 판매자 본인 또는 관리자만 접근
  - 기간별 정산 내역 조회
  - 페이징 처리
- **정산 상세 조회**:
  - 개별 정산의 상세 항목 조회
  - 원천 주문/환불 정보 확인
  - 수수료, 세금 내역 상세 표시

#### 2.1.4 부분 실패 재처리 (UC-S5)
- **실패 시나리오**:
  - 특정 판매자 데이터 문제
  - 일시적 시스템 장애
- **재처리 기능**:
  - 실패한 판매자만 선택적 재실행
  - 성공한 판매자는 유지

### 2.2 보조 기능

#### 2.2.1 수동 조정 항목
- **조정 유형**:
  - 프로모션 비용 보전
  - 수수료 특별 할인/증액
  - 기타 정산 조정
- **처리**: adjustment_amount에 반영

#### 2.2.2 정산 상태 관리
```
PENDING (처리 중)
    ↓
CONFIRMED (확정)
    ↓
PAID (지급 완료)

(CANCELED 가능)
```

#### 2.2.3 배치 실행 이력 관리
- 모든 배치 실행 로그 기록
- 성공/실패 판매자 수 집계
- 실행 시간, 처리 건수 기록

---

## 3. 비기능 요구사항

### 3.1 성능 요구사항
- **처리량**: 일일 100만 건 이상 처리 가능
- **응답시간**:
  - 정산 조회 API: 200ms 이내
  - 배치 처리: 1시간 이내 완료 (10만 건 기준)
- **동시성**: 다중 배치 실행 방지 (Lock机制)

### 3.2 신뢰성 요구사항
- **멱등성**: 동일 기간 재실행 시 중복 정산 방지
- **데이터 정합성**: BigDecimal 사용, CHECK 제약조건
- **트랜잭션**: 원자성 보장
- **이력 보존**: Soft Delete로 변경 이력 관리

### 3.3 보안 요구사항
- **인증**: JWT 기반 API 인증
- **권한**:
  - 판매자: 본인 정산만 조회
  - 관리자: 전체 정산 조회 및 재실행
- **데이터 보호**: 민감정보 암호화

### 3.4 운영 요구사항
- **모니터링**:
  - 배치 실행 상태 모니터링
  - 실패 알림 (Slack/email)
- **로그**: 상세한 실행 로그 기록
- **건강성**: Health Check API 제공

---

## 4. 데이터 모델

### 4.1 핵심 엔티티

#### 4.1.1 Settlement (정산)
```yaml
seller_id: 판매자 ID
cycle_type: DAILY/WEEKLY
period_start/end: 정산 기간
gross_sales_amount: 총 매출액
refund_amount: 환불액
commission_rate: 수수료율
commission_amount: 수수료액
tax_amount: 부가세
adjustment_amount: 조정액
payout_amount: 최종 지급액
status: PENDING/CONFIRMED/PAID/CANCELED
```

#### 4.1.2 SettlementItem (정산 항목)
```yaml
settlement_id: 정산 ID
source_type: ORDER/REFUND/ADJUSTMENT
source_id: 원천 ID
gross_amount: 원천 금액
commission_amount: 수수료
tax_amount: 세금
net_amount: 순수익
description: 설명
```

### 4.2 정산 금액 계산 공식
```
payout_amount = gross_sales_amount
                - refund_amount
                - commission_amount
                - tax_amount
                + adjustment_amount

where:
commission_amount = (gross_sales_amount - refund_amount) * commission_rate
tax_amount = commission_amount * 0.1
```

### 4.3 멱등성 보장
- Unique Index: (seller_id, cycle_type, period_start, status)
- ACTIVE 상태는 기간별 1개만 존재

---

## 5. 외부 인터페이스

### 5.1 API 명세
- `GET /api/v1/sellers/{sellerId}/settlements` - 판매자 정산 목록
- `GET /api/v1/settlements/{settlementId}` - 정산 상세 조회
- `GET /api/v1/settlements/{settlementId}/items` - 정산 항목 목록
- `POST /api/v1/admin/settlements/rerun` - 정산 재실행
- `GET /api/v1/admin/settlement-job-executions` - 배치 실행 이력

### 5.2 배치 스케줄러
- Spring Batch + Scheduler
- 매일 02:00 자동 실행
- 실패 시 재시도 정책

---

## 6. 제출물

### 6.1 개발 산출물
1. **소스 코드**
   - Domain Entity 클래스
   - Spring Batch Job
   - Repository/Service/Controller
   - 통합 테스트 코드

2. **데이터베이스**
   - Flyway 마이그레이션 스크립트
   - 테스트 데이터 셋

3. **문서**
   - API 명세서
   - 배치 운영 가이드
   - 트러블슈팅 가이드

### 6.2 배포 산출물
1. Docker 이미지
2. Docker Compose 설정
3. 배포 스크립트

---

## 7. 검수 기준

### 7.1 기능 검수
- [ ] 일일 정산 자동 실행
- [ ] 정확한 금액 계산 (소수점 2자리)
- [ ] 모든 환불 시나리오 처리
- [ ] 중복 정산 방지
- [ ] 재정산 기능
- [ ] API 응답 시간 200ms 이내

### 7.2 비기능 검수
- [ ] 10만 건 배치 처리 1시간 이내
- [ ] 데이터 정합성 검증
- [ ] 실패 시나리오 복구 테스트
- [ ] 동시성 테스트
- [ ] 장애 복구 테스트

---

## 8. 리스크 및 대책

### 8.1 기술 리스크
1. **대용량 처리 장애**
   - 대책: Chunk 기반 처리, 제한된 페이지 크기
2. **금액 계산 오류**
   - 대책: BigDecimal 사용, 단위 테스트 100% 커버리지
3. **데이터 정합성**
   - 대책: 트랜잭션 관리, 제약조건 설정

### 8.2 운영 리스크
1. **배치 실행 실패**
   - 대책: 재시도 정책, 부분 재처리 기능
2. **성능 저하**
   - 대책: 인덱스 최적화, 쿼리 튜닝

---

## 9. 일정

- **1주차**: 도메인 모델링, Entity 구현
- **2주차**: Spring Batch Job 구현
- **3주차**: 정산 계산 로직, API 개발
- **4주차**: 통합 테스트, 성능 튜닝

---

## 10. 부록

- 관련 문서 링크
  - [정산 규칙 및 정책](./정산%20규칙%20및%20정책.md)
  - [유스케이스 명세서](./유스케이스%20명세서.md)
  - [도메인 정의서](./도메인%20정의서.md)
  - [ERD 및 테이블 설계](./ERD%20및%20테이블%20설계.md)