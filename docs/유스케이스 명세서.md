---
title: 마켓플레이스 정산 시스템 - 유스케이스 명세서
created: 2025-12-01
updated: 2025-12-01
tags: [project, settlement, usecase, specification]
category: Projects
status: draft
---

# 유스케이스 명세서

## 개요

본 문서는 마켓플레이스 판매자 정산 시스템의 핵심 유스케이스를 정의한다. 각 유스케이스는 시스템의 기능 요구사항을 Actor-Goal 관점에서 상세히 기술한다.

### 유스케이스 목록

| ID | 유스케이스명 | Primary Actor | 우선순위 |
|----|-------------|---------------|----------|
| UC-S1 | 매일 정산 배치 실행 | Scheduler | 필수 |
| UC-S2 | 관리자에 의한 정산 재실행 | Admin | 필수 |
| UC-S3 | 판매자 정산 목록 조회 | Seller / Admin | 필수 |
| UC-S4 | 특정 정산 상세 항목 조회 | Seller / Admin | 필수 |
| UC-S5 | 실패한 Seller만 재처리 | Admin | 권장 |

### Actor 정의

| Actor | 설명 | 권한 |
|-------|------|------|
| Scheduler | 시스템 스케줄러 (Cron/Spring Batch) | 배치 실행 |
| Admin | 정산 관리자 | 전체 정산 조회/재실행/조정 |
| Seller | 판매자 | 본인 정산 조회 |

---

## UC-S1. 매일 정산 배치 실행

### 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-S1 |
| **Use Case Name** | 매일 정산 배치 실행 (Run Daily Settlement Job) |
| **Primary Actor** | Scheduler (System) |
| **Scope** | Settlement System |
| **Level** | User Goal |

### Description

시스템 스케줄러가 매일 지정된 시각에 전일 발생한 결제 건에 대해 판매자별 정산을 자동 수행한다.

### Preconditions

| 구분 | 조건 |
|------|------|
| 데이터 | 전일(D-1) 결제 확정(CONFIRMED)된 Payment 데이터가 존재함 |
| 상태 | 동일 대상일자에 대해 COMPLETED 상태의 JobExecution이 없음 |
| 시스템 | 배치 스케줄러가 정상 동작 중임 |
| 시간 | 정산 대상 기간(전일)의 모든 거래가 마감됨 (익일 02:00 실행 권장) |

### Trigger

- **Primary**: Cron Schedule (매일 02:00 KST)
- **Secondary**: Admin 수동 실행 (UC-S2로 대체)

### Main Success Scenario

```
1. Scheduler가 DailySettlementJob을 실행한다.

2. System은 JobExecution을 생성하고 상태를 RUNNING으로 설정한다.
   - jobName: "DailySettlementJob"
   - targetDate: D-1 (전일)
   - cycle: DAILY
   - status: RUNNING
   - startedAt: 현재 시각

3. System은 정산 대상 기간을 계산한다.
   - periodStart: D-1 00:00:00
   - periodEnd: D-1 23:59:59

4. System은 해당 기간에 결제가 존재하는 Seller 목록을 조회한다.
   - Payment.status = 'CONFIRMED'
   - Payment.paidAt BETWEEN periodStart AND periodEnd
   - Seller.status = 'ACTIVE'

5. System은 각 Seller에 대해 순차적으로 정산을 수행한다.
   5.1. 해당 Seller의 정산 대상 OrderItem을 조회한다.
   5.2. 해당 Seller의 환불(Refund) 내역을 조회한다.
   5.3. Settlement 엔티티를 생성한다 (status: PENDING).
   5.4. SALE 항목(SettlementItem)을 생성하여 연결한다.
   5.5. REFUND 항목(SettlementItem)을 생성하여 연결한다.
   5.6. 총액을 계산하고 검증한다 (Invariant 체크).
   5.7. Settlement를 저장한다.
   5.8. 성공 카운트를 증가시킨다.

6. System은 모든 Seller 처리 완료 후 JobExecution을 갱신한다.
   - status: COMPLETED
   - completedAt: 현재 시각
   - totalSellerCount: 처리 대상 수
   - successCount: 성공 수
   - failCount: 0
   - skipCount: 0

7. System은 배치 완료 로그를 기록한다.
```

### Alternative Flows

#### AF-1. 동일 대상일자에 이미 완료된 Job이 존재하는 경우

```
2a. System이 동일 targetDate + cycle에 COMPLETED 상태 JobExecution 발견 시:
    2a.1. System은 JobExecution을 생성하지 않는다.
    2a.2. System은 "Already executed" 로그를 기록한다.
    2a.3. 배치를 정상 종료한다 (중복 실행 방지).
```

#### AF-2. 특정 Seller 처리 중 오류 발생

```
5a. 특정 Seller의 정산 처리 중 예외 발생 시:
    5a.1. System은 해당 Seller의 트랜잭션을 롤백한다.
    5a.2. System은 failCount를 증가시킨다.
    5a.3. System은 에러 로그를 기록한다 (sellerId, errorMessage).
    5a.4. System은 다음 Seller 처리를 계속한다 (Fault Tolerant).

6a. failCount > 0인 경우:
    6a.1. JobExecution.status를 PARTIAL_COMPLETED로 설정한다.
    6a.2. System은 관리자에게 알림을 발송한다 (선택적).
```

#### AF-3. 정산 대상 Seller가 없는 경우

```
4a. 정산 대상 Seller가 0명인 경우:
    4a.1. System은 JobExecution을 생성한다.
    4a.2. status: COMPLETED, totalSellerCount: 0으로 기록한다.
    4a.3. 배치를 정상 종료한다 (빈 정산도 이력 남김).
```

### Postconditions

#### 성공 시

| 대상 | 상태 |
|------|------|
| JobExecution | status = COMPLETED, successCount = totalSellerCount |
| Settlement | 각 Seller별 1건 생성, status = PENDING |
| SettlementItem | 각 Settlement에 SALE/REFUND 항목 연결 |

#### 부분 실패 시

| 대상 | 상태 |
|------|------|
| JobExecution | status = PARTIAL_COMPLETED, failCount > 0 |
| Settlement | 성공한 Seller만 생성됨 |
| 실패 Seller | Settlement 미생성, 재처리 대상 (UC-S5) |

### Sequence Diagram

```
┌─────────┐     ┌─────────────┐     ┌────────────┐     ┌──────────────┐
│Scheduler│     │SettlementJob│     │ Calculator │     │ Repository   │
└────┬────┘     └──────┬──────┘     └─────┬──────┘     └──────┬───────┘
     │                 │                   │                   │
     │  execute()      │                   │                   │
     │────────────────>│                   │                   │
     │                 │                   │                   │
     │                 │ createJobExecution()                  │
     │                 │──────────────────────────────────────>│
     │                 │                   │                   │
     │                 │ findTargetSellers()                   │
     │                 │──────────────────────────────────────>│
     │                 │                   │                   │
     │                 │ [loop] for each seller               │
     │                 │ ─────────────────────────────────────│
     │                 │   │               │                   │
     │                 │   │ calculate()   │                   │
     │                 │   │──────────────>│                   │
     │                 │   │               │                   │
     │                 │   │               │ findOrderItems()  │
     │                 │   │               │──────────────────>│
     │                 │   │               │                   │
     │                 │   │               │ findRefunds()     │
     │                 │   │               │──────────────────>│
     │                 │   │               │                   │
     │                 │   │  Settlement   │                   │
     │                 │   │<──────────────│                   │
     │                 │   │               │                   │
     │                 │   │ save(settlement)                  │
     │                 │   │──────────────────────────────────>│
     │                 │ ─────────────────────────────────────│
     │                 │                   │                   │
     │                 │ updateJobExecution(COMPLETED)         │
     │                 │──────────────────────────────────────>│
     │                 │                   │                   │
     │   complete      │                   │                   │
     │<────────────────│                   │                   │
     │                 │                   │                   │
```

---

## UC-S2. 관리자에 의한 정산 재실행

### 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-S2 |
| **Use Case Name** | 관리자에 의한 정산 재실행 (Re-run Settlement for a Period) |
| **Primary Actor** | Admin |
| **Scope** | Settlement System |
| **Level** | User Goal |

### Description

관리자가 특정 기간/판매자에 대해 정산을 재실행한다. 기존 정산 데이터가 있는 경우 취소 처리 후 새로 계산한다.

### Preconditions

| 구분 | 조건 |
|------|------|
| 권한 | 요청자가 ADMIN 권한을 보유함 |
| 데이터 | 재실행 대상 기간의 원천 데이터(Order/Payment/Refund)가 존재함 |
| 상태 | 대상 Settlement가 PAID 상태가 아님 (지급 완료 건은 재실행 불가) |

### Trigger

- Admin이 관리자 화면에서 "정산 재실행" 버튼 클릭
- Admin이 API를 통해 재실행 요청

### Main Success Scenario

```
1. Admin이 재실행 대상 정보를 입력한다.
   - sellerId: 대상 판매자 ID (선택, 미입력 시 전체)
   - targetDate: 정산 대상일
   - cycle: DAILY / WEEKLY
   - reason: 재실행 사유 (필수)

2. System은 입력값을 검증한다.
   - targetDate가 미래 일자가 아닌지 확인
   - reason이 비어있지 않은지 확인

3. System은 기존 Settlement 존재 여부를 확인한다.
   - 조건: sellerId (또는 전체) + periodStart + periodEnd + status IN (PENDING, CONFIRMED)

4. System은 기존 Settlement가 존재하는 경우 취소 처리한다.
   4.1. 각 Settlement의 status를 CANCELED로 변경한다.
   4.2. cancelReason에 재실행 사유를 기록한다.
   4.3. canceledAt에 현재 시각을 기록한다.

5. System은 새로운 JobExecution을 생성한다.
   - jobName: "ManualSettlementJob"
   - targetDate: 입력값
   - triggeredBy: Admin ID
   - status: RUNNING

6. System은 정산을 재계산한다 (UC-S1의 Step 3~5와 동일).

7. System은 JobExecution을 완료 처리한다.
   - status: COMPLETED
   - reSettledCount: 재정산된 Settlement 수

8. System은 Admin에게 재실행 결과를 반환한다.
   - 성공/실패 건수
   - 생성된 Settlement ID 목록
```

### Alternative Flows

#### AF-1. 대상 Settlement가 PAID 상태인 경우

```
3a. 기존 Settlement 중 PAID 상태가 포함된 경우:
    3a.1. System은 오류를 반환한다.
         - ErrorCode: SETTLEMENT_ALREADY_PAID
         - Message: "지급 완료된 정산은 재실행할 수 없습니다.
                    조정(Adjustment)을 사용하세요."
    3a.2. Use Case를 종료한다.
```

#### AF-2. 검증 실패

```
2a. targetDate가 미래 일자인 경우:
    2a.1. System은 오류를 반환한다.
         - ErrorCode: INVALID_TARGET_DATE
         - Message: "미래 일자는 정산할 수 없습니다."

2b. reason이 비어있는 경우:
    2b.1. System은 오류를 반환한다.
         - ErrorCode: REASON_REQUIRED
         - Message: "재실행 사유는 필수입니다."
```

#### AF-3. 특정 판매자만 재실행 시 해당 판매자 데이터 없음

```
6a. 지정된 sellerId에 해당하는 정산 대상이 없는 경우:
    6a.1. System은 빈 Settlement를 생성하지 않는다.
    6a.2. JobExecution.status = COMPLETED, totalSellerCount = 0으로 기록한다.
    6a.3. Admin에게 "정산 대상 없음" 결과를 반환한다.
```

### Postconditions

#### 성공 시

| 대상 | 상태 |
|------|------|
| 기존 Settlement | status = CANCELED, cancelReason 기록됨 |
| 신규 Settlement | status = PENDING, reSettledFrom에 기존 ID 참조 |
| JobExecution | status = COMPLETED, triggeredBy = Admin ID |
| Audit Log | 재실행 이력 기록 (who, when, why) |

### Request/Response 예시

**Request**:
```json
POST /api/admin/settlements/re-run
{
  "sellerId": 12345,
  "targetDate": "2025-01-15",
  "cycle": "DAILY",
  "reason": "주문 데이터 누락 건 반영"
}
```

**Response (Success)**:
```json
{
  "success": true,
  "data": {
    "jobExecutionId": 9999,
    "canceledSettlementIds": [1001, 1002],
    "newSettlementIds": [1003],
    "totalAmount": 150000,
    "processedAt": "2025-01-16T10:30:00"
  }
}
```

---

## UC-S3. 판매자 정산 목록 조회

### 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-S3 |
| **Use Case Name** | 판매자 정산 목록 조회 (List Settlements for Seller) |
| **Primary Actor** | Seller / Admin |
| **Scope** | Settlement System |
| **Level** | User Goal |

### Description

판매자 또는 관리자가 특정 판매자의 정산 목록을 조회한다. 기간별, 상태별 필터링을 지원한다.

### Preconditions

| 구분 | 조건 |
|------|------|
| 인증 | 요청자가 시스템에 로그인되어 있음 |
| 권한 (Seller) | 본인의 정산만 조회 가능 |
| 권한 (Admin) | 모든 판매자의 정산 조회 가능 |

### Trigger

- Seller가 정산 관리 화면 접근
- Admin이 판매자 상세 화면에서 정산 탭 클릭

### Main Success Scenario

```
1. Actor가 정산 목록 조회를 요청한다.
   - sellerId: 조회 대상 판매자 ID (Seller는 자동 설정, Admin은 선택)
   - startDate: 조회 시작일 (선택, 기본값: 최근 3개월)
   - endDate: 조회 종료일 (선택, 기본값: 오늘)
   - status: 상태 필터 (선택, 기본값: 전체)
   - page: 페이지 번호 (기본값: 0)
   - size: 페이지 크기 (기본값: 20, 최대: 100)

2. System은 권한을 검증한다.
   - Seller: sellerId가 본인 ID와 일치하는지 확인
   - Admin: 제한 없음

3. System은 조회 조건에 맞는 Settlement 목록을 조회한다.
   - 정렬: periodStart DESC (최신순)

4. System은 각 Settlement의 요약 정보를 조합한다.
   - id, sellerId, cycle, periodStart, periodEnd
   - grossSalesAmount, refundAmount, commissionAmount, payoutAmount
   - status, createdAt, confirmedAt, paidAt
   - itemCount (SettlementItem 개수)

5. System은 페이징 정보와 함께 결과를 반환한다.
   - content: Settlement 목록
   - totalElements: 전체 건수
   - totalPages: 전체 페이지 수
   - currentPage: 현재 페이지
```

### Alternative Flows

#### AF-1. Seller가 타인의 정산을 조회하려는 경우

```
2a. Seller가 본인이 아닌 sellerId로 조회 요청 시:
    2a.1. System은 403 Forbidden 오류를 반환한다.
         - ErrorCode: ACCESS_DENIED
         - Message: "본인의 정산만 조회할 수 있습니다."
```

#### AF-2. 조회 결과가 없는 경우

```
3a. 조건에 맞는 Settlement가 없는 경우:
    3a.1. System은 빈 목록을 반환한다 (오류 아님).
         - content: []
         - totalElements: 0
```

### Postconditions

| 대상 | 상태 |
|------|------|
| Settlement | 변경 없음 (조회만) |
| Access Log | 조회 이력 기록 (선택적) |

### Request/Response 예시

**Request**:
```
GET /api/sellers/{sellerId}/settlements
    ?startDate=2025-01-01
    &endDate=2025-01-31
    &status=CONFIRMED
    &page=0
    &size=20
```

**Response**:
```json
{
  "success": true,
  "data": {
    "content": [
      {
        "id": 1001,
        "sellerId": 12345,
        "sellerName": "판매자A",
        "cycle": "DAILY",
        "periodStart": "2025-01-15",
        "periodEnd": "2025-01-15",
        "grossSalesAmount": 500000,
        "refundAmount": 50000,
        "commissionAmount": 45000,
        "taxAmount": 4500,
        "adjustmentAmount": 0,
        "payoutAmount": 400500,
        "status": "CONFIRMED",
        "itemCount": 25,
        "createdAt": "2025-01-16T02:30:00",
        "confirmedAt": "2025-01-16T09:00:00",
        "paidAt": null
      }
    ],
    "pagination": {
      "totalElements": 45,
      "totalPages": 3,
      "currentPage": 0,
      "size": 20
    }
  }
}
```

---

## UC-S4. 특정 정산 상세 항목 조회

### 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-S4 |
| **Use Case Name** | 특정 정산 상세 항목 조회 (View Settlement Detail) |
| **Primary Actor** | Seller / Admin |
| **Scope** | Settlement System |
| **Level** | User Goal |

### Description

판매자 또는 관리자가 특정 정산의 상세 정보와 개별 항목(SettlementItem) 목록을 조회한다.

### Preconditions

| 구분 | 조건 |
|------|------|
| 인증 | 요청자가 시스템에 로그인되어 있음 |
| 권한 (Seller) | 해당 Settlement가 본인 소유임 |
| 권한 (Admin) | 제한 없음 |
| 데이터 | 요청한 settlementId에 해당하는 Settlement가 존재함 |

### Trigger

- Actor가 정산 목록에서 특정 정산 클릭
- Actor가 정산 상세 URL 직접 접근

### Main Success Scenario

```
1. Actor가 정산 상세 조회를 요청한다.
   - settlementId: 조회 대상 정산 ID
   - itemType: 항목 유형 필터 (선택, SALE/REFUND/ADJUSTMENT)
   - itemPage: 항목 페이지 번호 (기본값: 0)
   - itemSize: 항목 페이지 크기 (기본값: 50)

2. System은 Settlement를 조회한다.

3. System은 권한을 검증한다.
   - Seller: Settlement.sellerId가 본인 ID와 일치하는지 확인
   - Admin: 제한 없음

4. System은 Settlement 기본 정보를 조합한다.
   - 정산 요약 (UC-S3과 동일)
   - 판매자 정보 (sellerName, businessNumber 등)
   - 상태 변경 이력 (createdAt, confirmedAt, paidAt, canceledAt)
   - 재정산 정보 (reSettledFrom, cancelReason - 해당 시)

5. System은 SettlementItem 목록을 조회한다.
   - 필터: itemType (선택적)
   - 정렬: type ASC, sourceCreatedAt ASC

6. System은 각 SettlementItem의 상세 정보를 조합한다.
   - id, type, sourceId, sourceType
   - amount, commission, tax, netAmount
   - 원천 데이터 요약 (orderNumber, productName 등)

7. System은 정산 상세 정보를 반환한다.
```

### Alternative Flows

#### AF-1. Settlement가 존재하지 않는 경우

```
2a. settlementId에 해당하는 Settlement가 없는 경우:
    2a.1. System은 404 Not Found 오류를 반환한다.
         - ErrorCode: SETTLEMENT_NOT_FOUND
         - Message: "정산 정보를 찾을 수 없습니다."
```

#### AF-2. Seller가 타인의 정산을 조회하려는 경우

```
3a. Seller가 본인 소유가 아닌 Settlement 조회 요청 시:
    3a.1. System은 403 Forbidden 오류를 반환한다.
         - ErrorCode: ACCESS_DENIED
         - Message: "해당 정산에 접근 권한이 없습니다."
```

### Postconditions

| 대상 | 상태 |
|------|------|
| Settlement | 변경 없음 (조회만) |
| SettlementItem | 변경 없음 (조회만) |

### Request/Response 예시

**Request**:
```
GET /api/settlements/{settlementId}
    ?itemType=SALE
    &itemPage=0
    &itemSize=50
```

**Response**:
```json
{
  "success": true,
  "data": {
    "settlement": {
      "id": 1001,
      "sellerId": 12345,
      "sellerName": "판매자A",
      "businessNumber": "123-45-67890",
      "cycle": "DAILY",
      "periodStart": "2025-01-15",
      "periodEnd": "2025-01-15",
      "grossSalesAmount": 500000,
      "refundAmount": 50000,
      "commissionAmount": 45000,
      "taxAmount": 4500,
      "adjustmentAmount": 0,
      "payoutAmount": 400500,
      "status": "CONFIRMED",
      "createdAt": "2025-01-16T02:30:00",
      "confirmedAt": "2025-01-16T09:00:00",
      "paidAt": null,
      "reSettledFrom": null,
      "cancelReason": null
    },
    "summary": {
      "saleCount": 23,
      "saleTotalAmount": 500000,
      "refundCount": 2,
      "refundTotalAmount": 50000,
      "adjustmentCount": 0,
      "adjustmentTotalAmount": 0
    },
    "items": {
      "content": [
        {
          "id": 5001,
          "type": "SALE",
          "sourceId": 88001,
          "sourceType": "ORDER_ITEM",
          "amount": 25000,
          "commission": 2500,
          "tax": 250,
          "netAmount": 22250,
          "sourceDetail": {
            "orderNumber": "ORD-2025-0115-001",
            "productName": "상품A",
            "quantity": 1,
            "paidAt": "2025-01-15T10:30:00"
          }
        }
      ],
      "pagination": {
        "totalElements": 23,
        "totalPages": 1,
        "currentPage": 0,
        "size": 50
      }
    }
  }
}
```

---

## UC-S5. 실패한 Seller만 재처리

### 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-S5 |
| **Use Case Name** | 실패한 Seller만 재처리 (Reprocess Failed Sellers in a Job) |
| **Primary Actor** | Admin |
| **Scope** | Settlement System |
| **Level** | User Goal |

### Description

관리자가 특정 배치 실행(JobExecution)에서 실패한 판매자들만 선택적으로 재처리한다. 전체 재실행(UC-S2) 대비 효율적인 복구 방법을 제공한다.

### Preconditions

| 구분 | 조건 |
|------|------|
| 권한 | 요청자가 ADMIN 권한을 보유함 |
| 데이터 | 대상 JobExecution이 존재하고, status가 PARTIAL_COMPLETED 또는 FAILED임 |
| 데이터 | 해당 Job의 실패 Seller 목록이 기록되어 있음 |

### Trigger

- Admin이 Job 실행 이력 화면에서 "실패 건 재처리" 버튼 클릭

### Main Success Scenario

```
1. Admin이 재처리 대상 JobExecution을 선택한다.
   - jobExecutionId: 대상 Job 실행 ID
   - sellerIds: 재처리할 Seller ID 목록 (선택, 미입력 시 전체 실패 건)

2. System은 JobExecution을 조회하고 검증한다.
   - status가 PARTIAL_COMPLETED 또는 FAILED인지 확인
   - failCount > 0인지 확인

3. System은 실패한 Seller 목록을 조회한다.
   - JobExecutionFailure 테이블에서 해당 jobExecutionId의 실패 Seller 조회
   - sellerIds가 지정된 경우 해당 목록으로 필터링

4. System은 새로운 JobExecution을 생성한다.
   - jobName: "RetrySettlementJob"
   - parentJobExecutionId: 원본 jobExecutionId (추적용)
   - targetDate: 원본 Job의 targetDate
   - status: RUNNING

5. System은 실패 Seller 각각에 대해 정산을 재시도한다.
   5.1. 해당 Seller의 기존 PENDING Settlement가 있으면 삭제한다.
   5.2. 정산을 계산한다 (UC-S1의 Step 5와 동일).
   5.3. 성공 시: successCount 증가, JobExecutionFailure에서 해당 Seller 제거.
   5.4. 실패 시: failCount 증가, 에러 로그 갱신.

6. System은 JobExecution을 완료 처리한다.
   - status: COMPLETED (전체 성공) 또는 PARTIAL_COMPLETED (일부 실패)

7. System은 원본 JobExecution의 상태를 갱신한다 (선택적).
   - 모든 실패 건이 복구된 경우: status를 COMPLETED로 변경

8. System은 Admin에게 재처리 결과를 반환한다.
```

### Alternative Flows

#### AF-1. 대상 JobExecution의 상태가 부적합한 경우

```
2a. JobExecution.status가 COMPLETED인 경우:
    2a.1. System은 오류를 반환한다.
         - ErrorCode: NO_FAILED_SELLERS
         - Message: "해당 Job에 실패한 판매자가 없습니다."

2b. JobExecution.status가 RUNNING인 경우:
    2b.1. System은 오류를 반환한다.
         - ErrorCode: JOB_STILL_RUNNING
         - Message: "아직 실행 중인 Job입니다. 완료 후 재시도하세요."
```

#### AF-2. 지정한 Seller가 실패 목록에 없는 경우

```
3a. sellerIds에 지정된 Seller가 실패 목록에 없는 경우:
    3a.1. System은 해당 Seller를 무시하고 계속 진행한다.
    3a.2. 응답에 skippedSellerIds로 포함하여 반환한다.
```

#### AF-3. 재처리 중에도 동일 오류 발생

```
5a. 재처리 시도에도 동일한 오류가 발생하는 경우:
    5a.1. System은 failCount를 증가시킨다.
    5a.2. JobExecutionFailure.retryCount를 증가시킨다.
    5a.3. retryCount >= 3인 경우 "수동 조치 필요" 플래그 설정.
```

### Postconditions

#### 전체 성공 시

| 대상 | 상태 |
|------|------|
| 신규 JobExecution | status = COMPLETED |
| 원본 JobExecution | status = COMPLETED (선택적 갱신) |
| 재처리 Settlement | status = PENDING, 정상 생성 |
| JobExecutionFailure | 해당 Seller 레코드 삭제 또는 resolved = true |

#### 일부 실패 시

| 대상 | 상태 |
|------|------|
| 신규 JobExecution | status = PARTIAL_COMPLETED |
| 원본 JobExecution | 변경 없음 |
| JobExecutionFailure | 여전히 실패한 Seller는 유지, retryCount 증가 |

### Request/Response 예시

**Request**:
```json
POST /api/admin/job-executions/{jobExecutionId}/retry
{
  "sellerIds": [12345, 12346]
}
```

**Response (Partial Success)**:
```json
{
  "success": true,
  "data": {
    "retryJobExecutionId": 10001,
    "originalJobExecutionId": 9999,
    "targetDate": "2025-01-15",
    "totalRetryCount": 2,
    "successCount": 1,
    "failCount": 1,
    "results": [
      {
        "sellerId": 12345,
        "status": "SUCCESS",
        "newSettlementId": 1005
      },
      {
        "sellerId": 12346,
        "status": "FAILED",
        "errorMessage": "주문 데이터 조회 실패: Connection timeout",
        "retryCount": 2
      }
    ],
    "processedAt": "2025-01-16T11:00:00"
  }
}
```

---

## 유스케이스 관계도

```
                                    ┌──────────────┐
                                    │   Scheduler  │
                                    └──────┬───────┘
                                           │
                                           ▼
                                    ┌──────────────┐
                         ┌─────────│   UC-S1      │
                         │         │ Daily Batch  │
                         │         └──────────────┘
                         │                │
                         │                │ 실패 시
                         │                ▼
┌─────────┐       ┌──────────────┐ ┌──────────────┐
│  Admin  │──────▶│   UC-S2      │ │   UC-S5      │
└─────────┘       │  Re-run      │ │ Retry Failed │
     │            └──────────────┘ └──────────────┘
     │
     │            ┌──────────────┐
     └───────────▶│   UC-S3      │
     │            │ List View    │
     │            └──────┬───────┘
     │                   │
     │                   ▼
     │            ┌──────────────┐
     └───────────▶│   UC-S4      │
                  │ Detail View  │
                  └──────────────┘
                         ▲
                         │
                  ┌──────┴───────┐
                  │    Seller    │
                  └──────────────┘
```

---

## 관련 문서

- [[도메인 정의서]]
- [[정산 규칙 및 정책]]
- [[사이드 프로젝트 공통 가이드]]
