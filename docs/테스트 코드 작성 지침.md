# 테스트 코드 작성 지침

> 이 문서는 프로젝트의 테스트 작성 표준을 정의합니다.  
> AI에게 테스트를 요청할 때도 이 지침을 참조하세요.

---

## 1. 테스트 피라미드 원칙

```
          ◢████████████◣
         /   E2E 테스트   \        ← 최소 (수동 검증 포함)
        ◢██████████████████◣
       /    통합 테스트      \       ← @SpringBootTest + Testcontainers
      ◢██████████████████████████◣
     /      슬라이스 테스트       \    ← @WebMvcTest, @DataJpaTest
    ◢██████████████████████████████████◣
   /          단위 테스트            \   ← 순수 Java, Spring 없음
  ◤████████████████████████████████████████◥
```

| 레벨 | 비율 | 속도 | 대상 |
|-----|------|------|-----|
| **단위 테스트** | 60-70% | <50ms | 도메인 로직, 계산, 검증, 정책 |
| **슬라이스 테스트** | 20-30% | <500ms | Controller, Repository |
| **통합 테스트** | 10-15% | <5s | Job 실행, 트랜잭션 경계 |
| **E2E 테스트** | <5% | - | 시나리오 검증 |

> [!IMPORTANT]
> **Red-Green의 80% 이상은 단위/슬라이스 테스트에서 끝내세요.**  
> `@SpringBootTest`는 "통합이 제대로 붙는지"만 확인합니다.

---

## 2. 테스트 유형별 작성 가이드

### 2.1 단위 테스트 (Unit Test)

**대상**: 도메인 엔티티, 서비스 로직, 계산기, 검증기, 정책 클래스

```java
// ✅ 좋은 예: Spring 없이 순수 Java로 테스트
class CommissionCalculatorTest {
    private CommissionCalculator calculator;

    @BeforeEach
    void setUp() {
        calculator = new CommissionCalculator();  // new로 생성
    }

    @Test
    @DisplayName("수수료 계산 - 표준 케이스 (10% 수수료)")
    void calculateCommission_StandardRate() {
        // given
        BigDecimal amount = new BigDecimal("100000");
        BigDecimal commissionRate = new BigDecimal("0.10");

        // when
        BigDecimal commission = calculator.calculateCommission(amount, commissionRate);

        // then
        assertThat(commission).isEqualByComparingTo(new BigDecimal("10000.00"));
    }
}
```

```java
// ❌ 나쁜 예: 단순 로직에 Spring 컨텍스트 로딩
@SpringBootTest
class CommissionCalculatorTest {
    @Autowired CommissionCalculator calculator;  // 불필요한 DI
}
```

**필수 테스트 케이스**:
- [ ] 정상 케이스 (Happy Path)
- [ ] 경계값 (0, 1, 최대값)
- [ ] null/빈 값 처리
- [ ] 반올림/정밀도 검증 (금액 계산 시 필수)
- [ ] 예외 발생 케이스

---

### 2.2 슬라이스 테스트 (Slice Test)

#### @WebMvcTest - Controller 테스트

**대상**: REST API 엔드포인트, 요청/응답 형식, 상태 코드

```java
@WebMvcTest(SettlementController.class)
class SettlementControllerTest {
    @Autowired MockMvc mockMvc;
    @MockBean SettlementService settlementService;

    @Test
    @DisplayName("정산 조회 API - 성공")
    void getSettlement_Success() throws Exception {
        // given
        when(settlementService.findById(1L))
            .thenReturn(SettlementDto.of(testSettlement));

        // when & then
        mockMvc.perform(get("/api/settlements/{id}", 1L))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.sellerId").value(1))
            .andExpect(jsonPath("$.payoutAmount").value(89000));
    }
}
```

**필수 검증 항목**:
- [ ] HTTP 상태 코드
- [ ] 응답 바디 필드 (주요 필드 실제 값 검증)
- [ ] 에러 응답 형식 (`@ExceptionHandler` 동작)
- [ ] 인증/인가 검증 (`@WithMockUser` 등)

---

#### @DataJpaTest - Repository 테스트

**대상**: 커스텀 쿼리, JPQL, Fetch Join, 집계 함수

```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = Replace.NONE)
@Testcontainers
class OrderRepositoryTest {
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");

    @Autowired OrderRepository orderRepository;

    @Test
    @DisplayName("Fetch Join으로 N+1 문제 방지 확인")
    void findWithOrderItems_NoNPlusOne() {
        // given
        Order order = createOrderWithItems(3);
        orderRepository.save(order);

        // when
        Order found = orderRepository.findWithOrderItemsById(order.getId());

        // then
        assertThat(found.getOrderItems()).hasSize(3);
        // Proxy가 아닌 실제 객체인지 확인
        assertThat(Hibernate.isInitialized(found.getOrderItems())).isTrue();
    }
}
```

**필수 검증 항목**:
- [ ] 쿼리 결과 정확성
- [ ] Fetch Join 동작 (N+1 방지)
- [ ] 집계 함수 결과 (`SUM`, `COUNT` 등)
- [ ] 페이징 동작

---

### 2.3 통합 테스트 (Integration Test)

**대상**: Batch Job, 트랜잭션 경계, 멱등성, 외부 시스템 연동

```java
@SpringBootTest
@SpringBatchTest
@AutoConfigureTestDatabase(replace = Replace.NONE)
class DailySettlementJobTest extends AbstractBatchTest {

    @Test
    @DisplayName("멱등성 검증 - 동일 기간 중복 실행 시 Skip")
    void executeJob_Idempotency() throws Exception {
        // given
        createOrdersForSeller(testSeller, targetDate, 2);
        
        // when - 첫 번째 실행
        JobExecution execution1 = jobLauncherTestUtils.launchJob(params);
        assertThat(execution1.getStatus()).isEqualTo(BatchStatus.COMPLETED);
        long countAfterFirst = settlementRepository.count();

        // when - 두 번째 실행 (동일 날짜)
        JobExecution execution2 = jobLauncherTestUtils.launchJob(params2);

        // then - 정산 데이터 중복 생성 안됨
        assertThat(settlementRepository.count()).isEqualTo(countAfterFirst);
    }
}
```

**필수 검증 항목**:
- [ ] Job 실행 성공/실패 상태
- [ ] 멱등성 (중복 실행 시 동일 결과)
- [ ] 트랜잭션 롤백 시나리오
- [ ] Chunk 단위 실패 복구

---

## 3. Testcontainers 사용 가이드

### 3.1 컨테이너 공유 패턴 (필수)

```java
// ✅ 권장: static 초기화로 테스트 간 컨테이너 공유
public abstract class AbstractBatchTest {
    static final MySQLContainer<?> mysql;

    static {
        mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("settlement_test");
        mysql.start();  // 한 번만 실행
    }

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        // ...
    }
}
```

```java
// ❌ 비권장: 매 테스트마다 컨테이너 재시작
@Testcontainers
class SlowTest {
    @Container  // 매번 새 컨테이너 → 느림
    MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");
}
```

### 3.2 테스트 격리

```java
@BeforeEach
void setUp() {
    // 트랜잭션 내에서 데이터 정리
    transactionTemplate.execute(status -> {
        settlementRepository.deleteAll();
        orderRepository.deleteAll();
        return null;
    });
}
```

---

## 4. AI에게 테스트 요청 시 프롬프트 가이드

### 4.1 단위 테스트 요청

```markdown
"`CommissionCalculator`에 대한 단위 테스트를 작성해줘.

요구사항:
- Spring 없이, `new`로 객체 생성
- given-when-then 패턴 사용
- `@DisplayName`으로 한글 설명 필수
- 경계값(0, null, 최대값)과 반올림 케이스 포함
- `@ParameterizedTest`로 다양한 입력값 검증"
```

### 4.2 슬라이스 테스트 요청

```markdown
"`SettlementController`에 대한 슬라이스 테스트를 작성해줘.

요구사항:
- `@WebMvcTest` 사용
- 서비스 레이어는 `@MockBean`으로 Mock
- 성공/실패 케이스 모두 작성
- 응답 바디의 실제 값 검증 (`jsonPath`)
- 에러 응답 형식도 검증"
```

### 4.3 통합 테스트 요청

```markdown
"`DailySettlementJob`에 대한 통합 테스트를 작성해줘.

요구사항:
- `AbstractBatchTest` 상속 (Testcontainers MySQL 사용)
- `TransactionTemplate`으로 데이터 정리
- 멱등성, 에러 복구, 청크 트랜잭션 검증
- Fetch Join 시 `Hibernate.initialize()` 확인"
```

---

## 5. 피해야 할 안티패턴

### 5.1 ❌ @SpringBootTest 남발
```java
// 단순 계산 로직에 전체 컨텍스트 로딩 → 느림
@SpringBootTest
class CalculatorTest { ... }
```

### 5.2 ❌ Mock 과다 사용 (테스트가 구현을 복사)
```java
// Mock이 반환하는 걸 다시 Mock이 검증 → 무의미
when(repo.findById(1L)).thenReturn(Optional.of(entity));
assertThat(service.findById(1L)).isEqualTo(entity);  // 당연히 통과
```

### 5.3 ❌ 검증이 너무 약함
```java
// 상태 코드만 검증 → 회귀 잡기 실패
mockMvc.perform(get("/api/settlements/1"))
    .andExpect(status().isOk());  // 바디 검증 없음
```

### 5.4 ❌ 시간/랜덤 의존 (Flaky Test)
```java
// 실행 시간에 따라 결과 달라짐
assertThat(order.getCreatedAt()).isEqualTo(LocalDateTime.now());  // 플래키!
```

### 5.5 ❌ 구현 디테일 종속
```java
// 테이블명 변경 시 테스트 깨짐
verify(jdbcTemplate).update("INSERT INTO settlements ...");
```

---

## 6. 테스트 명명 규칙

### 6.1 @DisplayName 사용 (필수)

```java
@Test
@DisplayName("환불 포함 정산 계산 - 순매출에서 환불액 차감 후 수수료 적용")
void executeJob_WithRefund() { ... }
```

### 6.2 메서드명 컨벤션

```
[메서드명]_[시나리오]_[예상결과]
```

```java
calculateCommission_NullInput_ReturnsZero()
executeJob_DuplicateExecution_SkipsCreation()
findById_NotExists_ThrowsNotFoundException()
```

---

## 7. 품질 체크리스트

### PR 제출 전 확인

- [ ] 기능 변경에 대응하는 테스트 변경이 있는가?
- [ ] 새 기능에 대한 단위 테스트가 있는가?
- [ ] 경계값/에러 케이스가 포함되어 있는가?
- [ ] `@DisplayName`이 테스트 목적을 명확히 설명하는가?
- [ ] given-when-then 구조가 명확한가?
- [ ] Flaky할 가능성이 있는 코드가 없는가?

### 통합 테스트 추가 시 확인

- [ ] Testcontainers 공유 패턴을 사용하는가?
- [ ] 데이터 격리가 보장되는가?
- [ ] 멱등성 검증이 포함되어 있는가?

---

## 8. 프로젝트 테스트 구조

```
src/test/java/com/company/settlement/
├── batch/
│   ├── AbstractBatchTest.java          # 통합 테스트 공통 설정
│   ├── job/
│   │   └── DailySettlementJobTest.java # Batch Job 통합 테스트
│   └── service/
│       └── CommissionCalculatorTest.java # 순수 단위 테스트
├── domain/                              # (권장) 엔티티 단위 테스트
│   ├── OrderTest.java
│   └── SettlementTest.java
├── repository/                          # Repository 슬라이스 테스트
│   ├── AbstractRepositoryTest.java
│   ├── OrderRepositoryTest.java
│   └── SettlementRepositoryTest.java
└── controller/                          # (권장) Controller 슬라이스 테스트
    └── SettlementControllerTest.java
```

---

## 참고 자료

- [Spring Boot Testing Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.testing)
- [Testcontainers Best Practices](https://testcontainers.com/guides/)
- [Kent Beck - Test Driven Development](https://www.amazon.com/Test-Driven-Development-Kent-Beck/dp/0321146530)
